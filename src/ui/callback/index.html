<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrowsEZ - Authentication Success</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f8f9fa;
    }
    .container {
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    .success-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }
    p {
      color: #666;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    .countdown {
      color: #007acc;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="success-icon">✅</div>
    <h1>Authentication Successful!</h1>
    <p>You have successfully logged in to BrowsEZ.</p>
    <p>This tab will close automatically in <span class="countdown">3</span> seconds...</p>
    <p>You can now use the extension in your browser tabs.</p>
  </div>

  <script>
    // Check URL parameters for OAuth result
    const urlParams = new URLSearchParams(window.location.search);
    const hasCode = urlParams.has('code');
    const hasError = urlParams.has('error');
    
    // Update UI based on OAuth result
    const container = document.querySelector('.container');
    const icon = document.querySelector('.success-icon');
    const title = document.querySelector('h1');
    const message = document.querySelector('p');
    
    let countdown = 3;
    const countdownEl = document.querySelector('.countdown');
    
    if (hasError) {
      icon.textContent = '❌';
      title.textContent = 'Authentication Failed';
      message.innerHTML = `
        <p>There was an error during authentication:</p>
        <p style="color: #d73a49; font-weight: 600;">${urlParams.get('error_description') || urlParams.get('error') || 'Unknown error'}</p>
        <p>This tab will close automatically in <span class="countdown">5</span> seconds...</p>
        <p>Please try logging in again.</p>
      `;
      countdown = 5;
    } else if (hasCode) {
      // OAuth was successful
      icon.textContent = '✅';
      title.textContent = 'Authentication Successful!';
      message.innerHTML = `
        <p>You have successfully logged in to BrowsEZ.</p>
        <p>This tab will close automatically in <span class="countdown">3</span> seconds...</p>
        <p>You can now use the extension in your browser tabs.</p>
      `;
    } else {
      // Unexpected state
      icon.textContent = '⚠️';
      title.textContent = 'Unexpected Response';
      message.innerHTML = `
        <p>The authentication response was unexpected.</p>
        <p>This tab will close automatically in <span class="countdown">3</span> seconds...</p>
        <p>Please try logging in again.</p>
      `;
    }
    
    // Update countdown display
    const newCountdownEl = document.querySelector('.countdown');
    if (newCountdownEl) {
      newCountdownEl.textContent = countdown;
    }
    
    // Auto-close after countdown
    const timer = setInterval(() => {
      countdown--;
      if (newCountdownEl) {
        newCountdownEl.textContent = countdown;
      }
      
      if (countdown <= 0) {
        clearInterval(timer);
        
        // Notify extension about auth completion
        try {
          if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ 
              type: 'AUTH_COMPLETE',
              success: hasCode && !hasError,
              error: hasError ? (urlParams.get('error_description') || urlParams.get('error')) : null
            });
          }
        } catch (error) {
          console.log('Could not send message to extension:', error);
        }
        
        // Close the tab
        window.close();
      }
    }, 1000);
    
    // Also handle manual close
    window.addEventListener('beforeunload', () => {
      try {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
          chrome.runtime.sendMessage({ 
            type: 'AUTH_COMPLETE',
            success: hasCode && !hasError,
            error: hasError ? (urlParams.get('error_description') || urlParams.get('error')) : null
          });
        }
      } catch (error) {
        console.log('Could not send message to extension on unload:', error);
      }
    });
  </script>
</body>
</html>